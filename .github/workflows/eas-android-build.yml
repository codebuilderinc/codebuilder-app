name: ðŸš€ EAS Android Build & Smart Release

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build-android:
    name: ðŸ”¨ Build Android - Version Manager
    runs-on: ubuntu-latest
    outputs:
      build_id: ${{ steps.build.outputs.BUILD_ID }}
      app_version: ${{ steps.version-control.outputs.app_version }}
      build_number: ${{ steps.version-control.outputs.build_number }}
      build_date: ${{ steps.version-control.outputs.build_date }}
      is_production: ${{ steps.version-control.outputs.is_production }}
    steps:
      # ========================
      # ðŸ› ï¸ Repository Setup
      # ========================
      - name: "ðŸ“¦ Checkout (Full History)"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========================
      # âš™ï¸ Environment Configuration
      # ========================
      - name: "ðŸ“¦ Setup Node.js 20.x"
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "npm"

      - name: "ðŸ§© Install dependencies (ci)"
        run: npm ci

      # ========================
      # ðŸ”„ Version Management
      # ========================
      - name: "ðŸ”„ Update Production Version"
        if: github.ref == 'refs/heads/main'
        run: node --input-type=module scripts/version-update.js

      - name: "ðŸ”§ Configure Git for Automation"
        if: github.ref == 'refs/heads/main'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: "ðŸ’¾ Commit Version Update"
        if: github.ref == 'refs/heads/main'
        run: |
          git add app.config.js
          git commit -m "chore: Auto-increment version [skip ci]"
          git push

      # ========================
      # ðŸ“Œ Version Tagging
      # ========================
      - name: "ðŸ·ï¸ Set CI/CD Versions"
        id: version-control
        run: |
          # Set production or preview version
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            APP_VERSION=$(node -p "require('./app.config.js').expo.version")
            IS_PRODUCTION="true"
          else
            APP_VERSION="1.0.0-prerelease.${{ github.run_number }}"
            IS_PRODUCTION="false"
          fi

          # Generate build identifiers
          BUILD_NUMBER="${{ github.run_id }}"
          BUILD_DATE=$(date +'%Y%m%d-%H%M%S')

          # Set outputs for downstream jobs
          echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "is_production=$IS_PRODUCTION" >> $GITHUB_OUTPUT

          # Export environment variables
          echo "APP_VERSION=$APP_VERSION" >> $GITHUB_ENV
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV

      # ========================
      # ðŸ” EAS Setup & Auth
      # ========================
      - name: "âš™ï¸ Install EAS CLI"
        run: npm install -g eas-cli@latest

      - name: "ðŸ” Verify Expo Credentials"
        run: npx eas whoami --token $EXPO_TOKEN

      # ========================
      # ðŸ—ï¸ Build Execution
      # ========================
      - name: "ðŸš€ Trigger EAS Build"
        id: build
        run: |
          echo "ðŸ”„ Initializing build process..."
          sudo apt-get install -y jq

          # Execute build and capture metadata
          BUILD_JSON=$(npx eas build -p android --profile production --non-interactive --json)
          BUILD_ID=$(echo "$BUILD_JSON" | jq -r '.[0].id')

          # Export build ID for downstream jobs
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_OUTPUT

  download-apk:
    name: "ðŸ“¥ APK Artifact Handler"
    runs-on: ubuntu-latest
    needs: build-android
    outputs:
      apk_path: ${{ steps.download.outputs.APK_PATH }}
    steps:
      # ========================
      # ðŸ› ï¸ Environment Setup
      # ========================
      - name: "ðŸ“¦ Checkout Repository"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      # ========================
      # ðŸ“¦ Dependency Management
      # ========================
      - name: "ðŸ§° Install Build Tools"
        run: |
          npm install -g eas-cli@latest
          sudo apt-get install -y jq curl

      # ========================
      # ðŸ” Build Monitoring
      # ========================
      - name: "â³ Wait for Build Completion"
        run: |
          echo "â° Monitoring build status..."
          npx eas build:wait --build-id ${{ needs.build-android.outputs.build_id }} --timeout 1800

      # ========================
      # ðŸ“¦ Artifact Handling
      # ========================
      - name: "ðŸ“¥ Download APK"
        id: download
        run: |
          echo "ðŸ”½ Retrieving APK URL..."
          APK_URL=$(npx eas build:list --build-id ${{ needs.build-android.outputs.build_id }} --json | jq -r '.[0].artifacts.url')
          echo "ðŸ“¥ Downloading APK from $APK_URL..."
          curl -L "$APK_URL" -o app-release.apk
          echo "APK_PATH=app-release.apk" >> $GITHUB_OUTPUT

      - name: "ðŸ“¤ Upload Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: app-release.apk

  generate-changelog:
    name: "ðŸ“œ Changelog Generator"
    runs-on: ubuntu-latest
    needs: build-android
    outputs:
      changelog: ${{ steps.changelog.outputs.CHANGELOG }}
    steps:
      # ========================
      # ðŸ› ï¸ Repository Setup
      # ========================
      - name: "ðŸ“‚ Checkout with Full History"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========================
      # ðŸ“„ Changelog Generation
      # ========================
      - name: "ðŸ“‹ Create Release Notes"
        id: changelog
        run: |
          echo "ðŸ“ Generating changelog from git history..."
          CHANGELOG=$(git log --pretty=format:"- %s (%h) by %an" -n 15)
          echo "$CHANGELOG" > changelog.txt
          echo "CHANGELOG=$(cat changelog.txt)" >> $GITHUB_OUTPUT

      - name: "ðŸ“¤ Upload Changelog"
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.txt

  create-release:
    name: "ðŸš€ Smart Release Publisher"
    runs-on: ubuntu-latest
    needs: [build-android, download-apk, generate-changelog]
    steps:
      # ========================
      # ðŸ“¥ Artifact Retrieval
      # ========================
      - name: "ðŸ“¦ Get APK Artifact"
        uses: actions/download-artifact@v4
        with:
          name: android-apk

      - name: "ðŸ“„ Get Changelog"
        uses: actions/download-artifact@v4
        with:
          name: changelog

      # ========================
      # ðŸ·ï¸ Release Creation
      # ========================
      - name: "ðŸŽšï¸ Determine Release Type"
        id: release-type
        run: |
          echo "ðŸ” Detecting release type..."
          if [ "${{ needs.build-android.outputs.is_production }}" = "true" ]; then
            echo "ðŸŸ¢ Production release detected"
            echo "RELEASE_TAG=v${{ needs.build-android.outputs.app_version }}" >> $GITHUB_ENV
            echo "RELEASE_TITLE=Production Release v${{ needs.build-android.outputs.app_version }}" >> $GITHUB_ENV
          else
            echo "ðŸŸ¡ Nightly build detected"
            echo "RELEASE_TAG=nightly-${{ needs.build-android.outputs.build_date }}" >> $GITHUB_ENV
            echo "RELEASE_TITLE=Nightly Build (${{ needs.build-android.outputs.build_date }})" >> $GITHUB_ENV
          fi

      - name: "ðŸŽ‰ Publish GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_TITLE }}
          body_path: changelog.txt
          files: app-release.apk
          prerelease: ${{ needs.build-android.outputs.is_production != 'true' }}
